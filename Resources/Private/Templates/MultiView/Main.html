<f:comment>
<!--
 * (c) Kitodo. Key to digital objects e.V. <contact@kitodo.org>
 *
 * This file is part of the Kitodo and TYPO3 projects.
 *
 * @license GNU General Public License version 3 or later.
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
-->
</f:comment>
<html xmlns:f="http://typo3.org/ns/TYPO3/CMS/Fluid/ViewHelpers"
      data-namespace-typo3-fluid="true">

<div class="page-control">
    <div class="backs">
        <span class="prev">
            <a href="#" data-page-control-selector=".backs .prev a"><f:translate key="prevPage" /></a>
        </span>
    </div>
    <div class="measureBacks">
        <span class="prev">
            <a href="#" data-page-control-selector=".measureBacks .prev a"><f:translate key="prevMeasure" /></a>
        </span>
    </div>
    <div class="fwds">
        <span class="next">
            <a href="#" data-page-control-selector=".fwds .next a"><f:translate key="nextPage" /></a>
        </span>
    </div>
    <div class="measureFwds">
        <span class="next">
            <a href="#" data-page-control-selector=".measureFwds .next a" ></f:translate key="nextMeasure" /></a>
        </span>
    </div>
</div>
<div class="grid-stack-wrapper">
    <div class="grid-stack">
        <f:for each="{multiViewDocuments}" as="document" iteration="iterator" >
            <div class="grid-stack-item {f:if(condition: '{document.sourceKey} >= 0', then: 'grid-stack-item-highlighted')}" gs-w="6" gs-h="6" gs-id="{iterator.index}" >
                <div class="grid-stack-item-content" style="overflow: hidden">
                    <div class="loader" ><div class="spinner"></div></div>
                    <iframe src="/viewer?tx_dlf%5Bid%5D={document.encodedUrl}&tx_dlf%5Bpage%5D={document.page}&tx_dlf%5Bmultiviewembedded%5D=1" width="100%" height="100%" style="overflow: hidden;" ></iframe>
                </div>
                <div class="gridstack-dragging-handle" title="{f:translate(key: 'multiview.dragging_label', extensionName: 'dfgviewer')}"></div>
                <f:if condition="{document.sourceKey} >= 0">
                    <div class="removeDocument">
                        <f:link.action addQueryString="untrusted" argumentsToBeExcludedFromQueryString="{0: 'tx_dlf[multiViewSource][{document.sourceKey}]', 1: 'tx_dlf[multiview]'}">
                            <f:translate key="multiview.remove_document" extensionName="dfgviewer" />
                        </f:link.action>
                    </div>
                </f:if>
            </div>
        </f:for>
    </div>
</div>
<script>
    const iframes = document.querySelectorAll('.grid-stack iframe');
    iframes.forEach(iframe => {
        iframe.addEventListener('load', () => {
            iframe.parentNode.querySelector('.loader').style.display = 'none';
            document.querySelectorAll('.page-control > div a').forEach(link => {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                const pageControl = iframeDoc.querySelector('.page-control ' + link.dataset.pageControlSelector);
                const div = link.closest('div');
                if(pageControl) {
                    div.style.display = 'block';
                }
            });
        });
    });

    const multiviewControls = document.querySelectorAll(".page-control a");
    multiviewControls.forEach(multiviewControl => {
        multiviewControl.addEventListener("click", function (event) {
            event.preventDefault(); // stops navigation
            const clicked = event.currentTarget;

            const loadedIframes = Array.from(document.querySelectorAll('.grid-stack iframe')).filter(iframe => {
                try {
                    // Accessing contentDocument throws an error if cross-origin
                    return iframe.contentDocument && iframe.contentDocument.readyState === 'complete';
                } catch (e) {
                    return false;
                }
            });

            loadedIframes.forEach(iframe => {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                const pageControl = iframeDoc.querySelector('.page-control ' + clicked.dataset.pageControlSelector);
                if(pageControl) {
                    // hide current page controls to decide again after iframe is loaded
                    document.querySelectorAll('.page-control > div').forEach(div => {
                        div.style.display = '';
                    });
                    pageControl.click();
                }
            });
        });
    });
</script>

</html>
